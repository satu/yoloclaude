#!/bin/bash
set -e

# YoloClaude - Secure Docker sandbox for AI coding agents
# Usage: ./yolo [command]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="${SCRIPT_DIR}/config.yaml"
ENV_FILE="${SCRIPT_DIR}/.env"
COMPOSE_FILE="${SCRIPT_DIR}/docker-compose.yaml"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Simple YAML parser for our config format
parse_yaml_value() {
    local key="$1"
    local value
    value=$(grep "^${key}:" "$CONFIG_FILE" 2>/dev/null | sed "s/^${key}:[[:space:]]*//")
    # Expand ~ to HOME using bash substitution (avoids sed delimiter issues)
    echo "${value/#\~/$HOME}"
}

# Parse ports from config (returns space-separated list of host:container mappings)
parse_ports() {
    sed -n '/^ports:/,/^[a-z]/p' "$CONFIG_FILE" | \
        grep "^\s*-" | \
        sed 's/.*-\s*//' | \
        sed 's/#.*//' | \
        awk '{print $1}' | \
        grep -E '^[0-9]+:[0-9]+$' | \
        tr '\n' ' '
}

# Generate .env file from config
generate_env() {
    log_info "Generating environment from config..."

    local container_name=$(parse_yaml_value "container_name")
    local username=$(parse_yaml_value "username")
    local src_dir=$(parse_yaml_value "src_dir")
    local claude_config_dir=$(parse_yaml_value "claude_config_dir")
    local claude_install_dir=$(parse_yaml_value "claude_install_dir")
    local claude_bin=$(parse_yaml_value "claude_bin")

    # Default username to current host user
    username="${username:-$(whoami)}"

    # Parse resources
    local memory=$(grep "memory:" "$CONFIG_FILE" | tail -1 | sed 's/.*memory:[[:space:]]*//')
    local cpus=$(grep "cpus:" "$CONFIG_FILE" | tail -1 | sed 's/.*cpus:[[:space:]]*//')

    # Expand ~ in paths
    src_dir="${src_dir/#\~/$HOME}"
    claude_config_dir="${claude_config_dir/#\~/$HOME}"
    claude_install_dir="${claude_install_dir/#\~/$HOME}"
    claude_bin="${claude_bin/#\~/$HOME}"

    cat > "$ENV_FILE" << EOF
# Auto-generated from config.yaml - do not edit directly
CONTAINER_NAME=${container_name:-yoloclaude}
USERNAME=${username}
USER_ID=$(id -u)
GROUP_ID=$(id -g)
SRC_DIR=${src_dir}
CLAUDE_CONFIG_DIR=${claude_config_dir}
CLAUDE_INSTALL_DIR=${claude_install_dir}
CLAUDE_BIN=${claude_bin}
MEMORY_LIMIT=${memory:-8g}
CPU_LIMIT=${cpus:-4}
EOF

    log_success "Environment file generated: $ENV_FILE"
}

# Generate docker-compose.yaml with custom ports
generate_compose() {
    local ports=$(parse_ports)
    local compose_ports=""
    local username=$(parse_yaml_value "username")
    username="${username:-$(whoami)}"

    for port in $ports; do
        compose_ports="${compose_ports}      - \"0.0.0.0:${port}\"\n"
    done

    # Read extra mounts
    local extra_mounts=""
    while IFS= read -r line; do
        if [[ "$line" =~ ^[[:space:]]*-[[:space:]]+(.*) ]]; then
            mount="${BASH_REMATCH[1]}"
            # Skip comments
            [[ "$mount" =~ ^# ]] && continue
            # Split into host:container[:options]
            IFS=':' read -r host_path container_path options <<< "$mount"
            # Expand ~ on host side to $HOME
            host_path="${host_path/#\~/$HOME}"
            # Expand ~ on container side to /home/$username
            container_path="${container_path/#\~/\/home\/${username}}"
            if [[ -n "$options" ]]; then
                extra_mounts="${extra_mounts}      - ${host_path}:${container_path}:${options}\n"
            else
                extra_mounts="${extra_mounts}      - ${host_path}:${container_path}\n"
            fi
        fi
    done < <(sed -n '/^extra_mounts:/,/^[a-z]/p' "$CONFIG_FILE" | tail -n +2)

    cat > "$COMPOSE_FILE" << 'COMPOSE_HEADER'
services:
  yoloclaude:
    build:
      context: .
      args:
        USERNAME: ${USERNAME}
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
    container_name: ${CONTAINER_NAME:-yoloclaude}
    hostname: yoloclaude

    volumes:
      # Named volume for persistent home directory
      - yoloclaude-home:/home/${USERNAME}
      # Bind mounts (overlay the named volume)
      - ${SRC_DIR}:/home/${USERNAME}/src
      - ${CLAUDE_CONFIG_DIR}:/home/${USERNAME}/.claude
      - ${CLAUDE_INSTALL_DIR}:/home/${USERNAME}/.local/share/claude:ro
      - ${CLAUDE_BIN}:/home/${USERNAME}/.local/bin/claude:ro
COMPOSE_HEADER

    # Add extra mounts if any
    if [[ -n "$extra_mounts" ]]; then
        echo -e "${extra_mounts}" >> "$COMPOSE_FILE"
    fi

    cat >> "$COMPOSE_FILE" << COMPOSE_PORTS
    ports:
COMPOSE_PORTS
    echo -e "${compose_ports}" >> "$COMPOSE_FILE"

    cat >> "$COMPOSE_FILE" << 'COMPOSE_FOOTER'
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-8g}
          cpus: "${CPU_LIMIT:-4}"

    stdin_open: true
    tty: true
    restart: unless-stopped

volumes:
  yoloclaude-home:
    name: yoloclaude-home
COMPOSE_FOOTER

    log_success "Compose file generated with ports: $ports"
}

# Check prerequisites
check_prereqs() {
    if ! command -v docker &> /dev/null; then
        log_error "Docker is not installed. Please install Docker first."
        exit 1
    fi

    if ! docker compose version &> /dev/null; then
        log_error "Docker Compose plugin is not installed."
        log_info "Install it with: sudo apt install docker-compose-plugin"
        exit 1
    fi

    if [[ ! -f "$CONFIG_FILE" ]]; then
        log_error "Config file not found: $CONFIG_FILE"
        exit 1
    fi
}

# Commands
cmd_build() {
    check_prereqs
    generate_env
    generate_compose
    log_info "Building Docker image..."
    docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" build "$@"
    log_success "Image built successfully!"
}

cmd_start() {
    check_prereqs
    generate_env
    generate_compose
    log_info "Starting container..."
    docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" up -d "$@"
    log_success "Container started!"
    log_info "Enter shell with: ./yolo shell"
}

cmd_stop() {
    check_prereqs
    log_info "Stopping container..."
    docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" down "$@"
    log_success "Container stopped."
}

cmd_shell() {
    check_prereqs
    local container_name=$(parse_yaml_value "container_name")
    container_name="${container_name:-yoloclaude}"

    if ! docker ps --format '{{.Names}}' | grep -q "^${container_name}$"; then
        log_warn "Container not running. Starting it first..."
        cmd_start
    fi

    log_info "Entering container shell..."
    docker exec -it "$container_name" bash
}

cmd_status() {
    check_prereqs
    local container_name=$(parse_yaml_value "container_name")
    container_name="${container_name:-yoloclaude}"

    echo ""
    if docker ps --format '{{.Names}}' | grep -q "^${container_name}$"; then
        log_success "Container is running"
        echo ""
        docker ps --filter "name=${container_name}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
    else
        log_warn "Container is not running"
    fi
    echo ""
}

cmd_logs() {
    check_prereqs
    docker compose -f "$COMPOSE_FILE" --env-file "$ENV_FILE" logs "$@"
}

cmd_restart() {
    cmd_stop
    cmd_start
}

cmd_rebuild() {
    cmd_stop 2>/dev/null || true
    cmd_build --no-cache
    cmd_start
}

cmd_help() {
    cat << EOF
${BLUE}YoloClaude${NC} - Secure Docker sandbox for AI coding agents

${YELLOW}Usage:${NC}
  ./yolo <command> [options]

${YELLOW}Commands:${NC}
  build      Build the Docker image
  start      Start the container
  stop       Stop the container
  shell      Enter interactive shell in the container
  status     Show container status
  logs       Show container logs (use -f to follow)
  restart    Stop and start the container
  rebuild    Rebuild image from scratch and restart
  help       Show this help message

${YELLOW}Configuration:${NC}
  Edit ${GREEN}config.yaml${NC} to customize ports, mounts, and resources.
  Changes take effect on next start/restart.

${YELLOW}Examples:${NC}
  ./yolo build          # Build the image
  ./yolo start          # Start the container
  ./yolo shell          # Enter the sandbox shell
  ./yolo logs -f        # Follow container logs
  ./yolo rebuild        # Full rebuild (no cache)

${YELLOW}Inside the container:${NC}
  - Your projects are at ~/src
  - Claude CLI is available as 'claude'
  - You have sudo access (passwordless)
  - Installed packages persist between restarts

EOF
}

# Main
case "${1:-help}" in
    build)   shift; cmd_build "$@" ;;
    start)   shift; cmd_start "$@" ;;
    stop)    shift; cmd_stop "$@" ;;
    shell)   shift; cmd_shell "$@" ;;
    status)  shift; cmd_status "$@" ;;
    logs)    shift; cmd_logs "$@" ;;
    restart) shift; cmd_restart "$@" ;;
    rebuild) shift; cmd_rebuild "$@" ;;
    help|--help|-h) cmd_help ;;
    *)
        log_error "Unknown command: $1"
        cmd_help
        exit 1
        ;;
esac
